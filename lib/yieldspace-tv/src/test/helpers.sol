// SPDX-License-Identifier: GPL-3.0-or-later
pragma solidity >=0.8.15;

import "../Math64x64.sol";

/// @dev Library wrapper contract to allow for try/catch logic within tests
contract ForTesting {
    using Math64x64 for int128;
    using Math64x64 for uint256;

    function exp(int128 x) public pure returns (int128) {
        return Math64x64.exp(x);
    }

    function pow(int128 x, uint256 y) public pure returns (int128) {
        return Math64x64.pow(x, y);
    }
}

/// @dev Testing utility functions
function abs(int256 x) pure returns (int256) {
    return x >= 0 ? x : -x;
}

function coerceUInt256To128(uint256 passedIn) pure returns (uint128) {
    uint256 min = type(uint128).min;
    uint256 max = type(uint128).max;
    uint256 range = max - min + 1;
    return uint128((passedIn % range) + min);
}

function coerceUInt256To128(
    uint256 passedIn,
    uint256 min,
    uint256 max
) pure returns (uint128) {
    uint256 range = max - min + 1;
    return uint128((passedIn % range) + min);
}

function coerceInt256To128(int256 passedIn) pure returns (int128) {
    int256 min = type(int128).min;
    int256 max = type(int128).max;
    int256 range = max - min + 1;
    return int128(abs(passedIn % range) + min);
}

// optionally call with min/max -- used for testing 'fromInt'
function coerceInt256To128(
    int256 passedIn,
    int256 min,
    int256 max
) pure returns (int128) {
    int256 range = max - min + 1;
    return int128(abs(passedIn % range) + min);
}

function maxInt128(int128 x, int128 y) pure returns (int128) {
    return x > y ? x : y;
}

function log2exp64x64(uint128 x) pure returns (uint128) {
    uint256 b = x;

    uint256 l = 0xFE000000000000000000000000000000;

    if (b < 0x10000000000000000) {
        l -= 0x80000000000000000000000000000000;
        b <<= 64;
    }
    if (b < 0x1000000000000000000000000) {
        l -= 0x40000000000000000000000000000000;
        b <<= 32;
    }
    if (b < 0x10000000000000000000000000000) {
        l -= 0x20000000000000000000000000000000;
        b <<= 16;
    }
    if (b < 0x1000000000000000000000000000000) {
        l -= 0x10000000000000000000000000000000;
        b <<= 8;
    }
    if (b < 0x10000000000000000000000000000000) {
        l -= 0x8000000000000000000000000000000;
        b <<= 4;
    }
    if (b < 0x40000000000000000000000000000000) {
        l -= 0x4000000000000000000000000000000;
        b <<= 2;
    }
    if (b < 0x80000000000000000000000000000000) {
        l -= 0x2000000000000000000000000000000;
        b <<= 1;
    }

    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x1000000000000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x800000000000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x400000000000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x200000000000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x100000000000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x80000000000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x40000000000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x20000000000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x10000000000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x8000000000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x4000000000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x2000000000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x1000000000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x800000000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x400000000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x200000000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x100000000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x80000000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x40000000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x20000000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x10000000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x8000000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x4000000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x2000000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x1000000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x800000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x400000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x200000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x100000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x80000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x40000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x20000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x10000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x8000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x4000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x2000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x1000000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x800000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x400000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x200000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x100000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x80000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x40000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x20000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x10000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x8000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x4000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x2000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x1000000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x800000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x400000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x200000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x100000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x80000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x40000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x20000000000000000;
    }
    b = (b * b) >> 127;
    if (b > 0x100000000000000000000000000000000) {
        b >>= 1;
        l |= 0x10000000000000000;
    }
    return uint128(l);
}

function pow2Exp64x64(uint128 x) pure returns (uint128) {
    uint256 r = 0x80000000000000000000000000000000;
    if (x & 0x1000000000000000000000000000000 > 0) r = (r * 0xb504f333f9de6484597d89b3754abe9f) >> 127;
    if (x & 0x800000000000000000000000000000 > 0) r = (r * 0x9837f0518db8a96f46ad23182e42f6f6) >> 127;
    if (x & 0x400000000000000000000000000000 > 0) r = (r * 0x8b95c1e3ea8bd6e6fbe4628758a53c90) >> 127;
    if (x & 0x200000000000000000000000000000 > 0) r = (r * 0x85aac367cc487b14c5c95b8c2154c1b2) >> 127;
    if (x & 0x100000000000000000000000000000 > 0) r = (r * 0x82cd8698ac2ba1d73e2a475b46520bff) >> 127;
    if (x & 0x80000000000000000000000000000 > 0) r = (r * 0x8164d1f3bc0307737be56527bd14def4) >> 127;
    if (x & 0x40000000000000000000000000000 > 0) r = (r * 0x80b1ed4fd999ab6c25335719b6e6fd20) >> 127;
    if (x & 0x20000000000000000000000000000 > 0) r = (r * 0x8058d7d2d5e5f6b094d589f608ee4aa2) >> 127;
    if (x & 0x10000000000000000000000000000 > 0) r = (r * 0x802c6436d0e04f50ff8ce94a6797b3ce) >> 127;
    if (x & 0x8000000000000000000000000000 > 0) r = (r * 0x8016302f174676283690dfe44d11d008) >> 127;
    if (x & 0x4000000000000000000000000000 > 0) r = (r * 0x800b179c82028fd0945e54e2ae18f2f0) >> 127;
    if (x & 0x2000000000000000000000000000 > 0) r = (r * 0x80058baf7fee3b5d1c718b38e549cb93) >> 127;
    if (x & 0x1000000000000000000000000000 > 0) r = (r * 0x8002c5d00fdcfcb6b6566a58c048be1f) >> 127;
    if (x & 0x800000000000000000000000000 > 0) r = (r * 0x800162e61bed4a48e84c2e1a463473d9) >> 127;
    if (x & 0x400000000000000000000000000 > 0) r = (r * 0x8000b17292f702a3aa22beacca949013) >> 127;
    if (x & 0x200000000000000000000000000 > 0) r = (r * 0x800058b92abbae02030c5fa5256f41fe) >> 127;
    if (x & 0x100000000000000000000000000 > 0) r = (r * 0x80002c5c8dade4d71776c0f4dbea67d6) >> 127;
    if (x & 0x80000000000000000000000000 > 0) r = (r * 0x8000162e44eaf636526be456600bdbe4) >> 127;
    if (x & 0x40000000000000000000000000 > 0) r = (r * 0x80000b1721fa7c188307016c1cd4e8b6) >> 127;
    if (x & 0x20000000000000000000000000 > 0) r = (r * 0x8000058b90de7e4cecfc487503488bb1) >> 127;
    if (x & 0x10000000000000000000000000 > 0) r = (r * 0x800002c5c8678f36cbfce50a6de60b14) >> 127;
    if (x & 0x8000000000000000000000000 > 0) r = (r * 0x80000162e431db9f80b2347b5d62e516) >> 127;
    if (x & 0x4000000000000000000000000 > 0) r = (r * 0x800000b1721872d0c7b08cf1e0114152) >> 127;
    if (x & 0x2000000000000000000000000 > 0) r = (r * 0x80000058b90c1aa8a5c3736cb77e8dff) >> 127;
    if (x & 0x1000000000000000000000000 > 0) r = (r * 0x8000002c5c8605a4635f2efc2362d978) >> 127;
    if (x & 0x800000000000000000000000 > 0) r = (r * 0x800000162e4300e635cf4a109e3939bd) >> 127;
    if (x & 0x400000000000000000000000 > 0) r = (r * 0x8000000b17217ff81bef9c551590cf83) >> 127;
    if (x & 0x200000000000000000000000 > 0) r = (r * 0x800000058b90bfdd4e39cd52c0cfa27c) >> 127;
    if (x & 0x100000000000000000000000 > 0) r = (r * 0x80000002c5c85fe6f72d669e0e76e411) >> 127;
    if (x & 0x80000000000000000000000 > 0) r = (r * 0x8000000162e42ff18f9ad35186d0df28) >> 127;
    if (x & 0x40000000000000000000000 > 0) r = (r * 0x80000000b17217f84cce71aa0dcfffe7) >> 127;
    if (x & 0x20000000000000000000000 > 0) r = (r * 0x8000000058b90bfc07a77ad56ed22aaa) >> 127;
    if (x & 0x10000000000000000000000 > 0) r = (r * 0x800000002c5c85fdfc23cdead40da8d6) >> 127;
    if (x & 0x8000000000000000000000 > 0) r = (r * 0x80000000162e42fefc25eb1571853a66) >> 127;
    if (x & 0x4000000000000000000000 > 0) r = (r * 0x800000000b17217f7d97f692baacded5) >> 127;
    if (x & 0x2000000000000000000000 > 0) r = (r * 0x80000000058b90bfbead3b8b5dd254d7) >> 127;
    if (x & 0x1000000000000000000000 > 0) r = (r * 0x8000000002c5c85fdf4eedd62f084e67) >> 127;
    if (x & 0x800000000000000000000 > 0) r = (r * 0x800000000162e42fefa58aef378bf586) >> 127;
    if (x & 0x400000000000000000000 > 0) r = (r * 0x8000000000b17217f7d24a78a3c7ef02) >> 127;
    if (x & 0x200000000000000000000 > 0) r = (r * 0x800000000058b90bfbe9067c93e474a6) >> 127;
    if (x & 0x100000000000000000000 > 0) r = (r * 0x80000000002c5c85fdf47b8e5a72599f) >> 127;
    if (x & 0x80000000000000000000 > 0) r = (r * 0x8000000000162e42fefa3bdb315934a2) >> 127;
    if (x & 0x40000000000000000000 > 0) r = (r * 0x80000000000b17217f7d1d7299b49c46) >> 127;
    if (x & 0x20000000000000000000 > 0) r = (r * 0x8000000000058b90bfbe8e9a8d1c4ea0) >> 127;
    if (x & 0x10000000000000000000 > 0) r = (r * 0x800000000002c5c85fdf4745969ea76f) >> 127;
    if (x & 0x8000000000000000000 > 0) r = (r * 0x80000000000162e42fefa3a0df5373bf) >> 127;
    if (x & 0x4000000000000000000 > 0) r = (r * 0x800000000000b17217f7d1cff4aac1e1) >> 127;
    if (x & 0x2000000000000000000 > 0) r = (r * 0x80000000000058b90bfbe8e7db95a2f1) >> 127;
    if (x & 0x1000000000000000000 > 0) r = (r * 0x8000000000002c5c85fdf473e61ae1f8) >> 127;
    if (x & 0x800000000000000000 > 0) r = (r * 0x800000000000162e42fefa39f121751c) >> 127;
    if (x & 0x400000000000000000 > 0) r = (r * 0x8000000000000b17217f7d1cf815bb96) >> 127;
    if (x & 0x200000000000000000 > 0) r = (r * 0x800000000000058b90bfbe8e7bec1e0d) >> 127;
    if (x & 0x100000000000000000 > 0) r = (r * 0x80000000000002c5c85fdf473dee5f17) >> 127;
    if (x & 0x80000000000000000 > 0) r = (r * 0x8000000000000162e42fefa39ef5438f) >> 127;
    if (x & 0x40000000000000000 > 0) r = (r * 0x80000000000000b17217f7d1cf7a26c8) >> 127;
    if (x & 0x20000000000000000 > 0) r = (r * 0x8000000000000058b90bfbe8e7bcf4a4) >> 127;
    if (x & 0x10000000000000000 > 0) r = (r * 0x800000000000002c5c85fdf473de72a2) >> 127;

    r >>= 127 - (x >> 121);

    return uint128(r);
}

/// @notice used for testing only
/// @dev Calculate x^y assuming 0^0 is 1, where x is unsigned 129.127 fixed point
/// number and y is unsigned 256-bit integer number.  Revert on overflow.
/// @param x unsigned 129.127-bit fixed point number
/// @param y uint256 value
/// @return unsigned 129.127-bit fixed point number
function powu(uint256 x, uint256 y) pure returns (uint256) {
    // NOTE: This is from the old ABDK Mathlib and is useful for testing the pow fn
    if (y == 0) return 0x80000000000000000000000000000000;
    else if (x == 0) return 0;
    else {
        int256 msb = 0;
        uint256 xc = x;
        if (xc >= 0x100000000000000000000000000000000) {
            xc >>= 128;
            msb += 128;
        }
        if (xc >= 0x10000000000000000) {
            xc >>= 64;
            msb += 64;
        }
        if (xc >= 0x100000000) {
            xc >>= 32;
            msb += 32;
        }
        if (xc >= 0x10000) {
            xc >>= 16;
            msb += 16;
        }
        if (xc >= 0x100) {
            xc >>= 8;
            msb += 8;
        }
        if (xc >= 0x10) {
            xc >>= 4;
            msb += 4;
        }
        if (xc >= 0x4) {
            xc >>= 2;
            msb += 2;
        }
        if (xc >= 0x2) msb += 1; // No need to shift xc anymore

        int256 xe = msb - 127;
        if (xe > 0) x >>= uint256(xe);
        else x <<= uint256(-xe);

        uint256 result = 0x80000000000000000000000000000000;
        int256 re = 0;

        while (y > 0) {
            if (y & 1 > 0) {
                result = result * x;
                y -= 1;
                re += xe;
                if (result >= 0x8000000000000000000000000000000000000000000000000000000000000000) {
                    result >>= 128;
                    re += 1;
                } else result >>= 127;
                if (re < -127) return 0; // Underflow
                require(re < 128); // Overflow
            } else {
                x = x * x;
                y >>= 1;
                xe <<= 1;
                if (x >= 0x8000000000000000000000000000000000000000000000000000000000000000) {
                    x >>= 128;
                    xe += 1;
                } else x >>= 127;
                if (xe < -127) return 0; // Underflow
                require(xe < 128); // Overflow
            }
        }

        if (re > 0) result <<= uint256(re);
        else if (re < 0) result >>= uint256(-re);

        return result;
    }
}
